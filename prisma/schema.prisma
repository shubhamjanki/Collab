generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(auto()) @map("_id") @db.ObjectId
  email         String    @unique
  name          String?
  password      String?   // For credentials-based authentication
  image         String?
  role          Role      @default(STUDENT)
  skills        String[]  // Array of skills
  bio           String?   
  university    String?
  profilePhoto  String?
  timezone      String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  projects      ProjectMember[]
  documents     Document[]
  chatMessages  ChatMessage[]
  documentRevisions DocumentRevision[]
  contributionSnapshots ContributionSnapshot[]
  sentInvitations     Invitation[] @relation("SentInvitations")
  assignedTasks       Task[] @relation("AssignedTasks")
  createdTasks        Task[] @relation("CreatedTasks")
  courses             Course[]
  rubrics             Rubric[]
  evaluations         Evaluation[]
  
  // Authentication (NextAuth)
  accounts      Account[]
  sessions      Session[]
}

enum Role {
  STUDENT
  FACULTY
  ORGANIZER
}

// NextAuth models
model Account {
  id                String  @id @default(auto()) @map("_id") @db.ObjectId
  userId            String  @db.ObjectId
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?  
  access_token      String?  
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?  
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  sessionToken String   @unique
  userId       String   @db.ObjectId
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Project {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  isPublic    Boolean  @default(false)
  inviteCode  String?  @unique
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  members     ProjectMember[]
  documents   Document[]
  chat        ChatMessage[]
  contributionSnapshots ContributionSnapshot[]
  invitations Invitation[]
  tasks       Task[]
  evaluation  Evaluation?
  
  // Hackathon link (optional)
  hackathonId String? @db.ObjectId
  hackathon   Hackathon? @relation(fields: [hackathonId], references: [id])
  
  // Course link (optional)
  courseId    String? @db.ObjectId
  course      Course? @relation(fields: [courseId], references: [id])
}

model ProjectMember {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  project   Project  @relation(fields: [projectId], references: [id])
  projectId String   @db.ObjectId
  user      User?    @relation(fields: [userId], references: [id])
  userId    String   @db.ObjectId
  role      MemberRole @default(MEMBER)
  joinedAt  DateTime @default(now())
  
  // Contribution tracking
  charactersAdded    Int @default(0)
  charactersRemoved  Int @default(0)
  editsCount         Int @default(0)
  lastActive         DateTime?
  
  @@unique([projectId, userId])
}

enum MemberRole {
  OWNER
  ADMIN
  MEMBER
}

model Document {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  title     String   @default("Untitled")
  content   String?  
  project   Project  @relation(fields: [projectId], references: [id])
  projectId String   @db.ObjectId
  author    User?    @relation(fields: [authorId], references: [id])
  authorId  String   @db.ObjectId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Versioning
  revisions DocumentRevision[]
  
  // Google Docs Integration
  googleDocUrl       String?  // Web view link for full editing
  googleDriveFileId  String?  // Google Drive file ID for permissions management
  
  // Public sharing
  shares    DocumentShare[]
}

model DocumentRevision {
  id         String   @id @default(auto()) @map("_id") @db.ObjectId
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentId String   @db.ObjectId
  content    String   
  userId     String   @db.ObjectId
  user       User     @relation(fields: [userId], references: [id])
  changes    Json?    // Store diff information
  createdAt  DateTime @default(now())
}

model DocumentShare {
  id         String    @id @default(auto()) @map("_id") @db.ObjectId
  document   Document  @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentId String    @db.ObjectId
  token      String    @unique  // Public share token
  createdAt  DateTime  @default(now())
  expiresAt  DateTime? // Optional expiry for sensitive documents
  viewCount  Int       @default(0)
}

model ChatMessage {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  project   Project  @relation(fields: [projectId], references: [id])
  projectId String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  userId    String   @db.ObjectId
  content   String   
  createdAt DateTime @default(now())
  
  // Index for performance
  @@index([projectId, createdAt])
}

model Hackathon {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  description String?
  startDate   DateTime
  endDate     DateTime
  isOnline    Boolean  @default(true)
  maxTeamSize Int      @default(5)
  createdAt   DateTime @default(now())
  
  projects    Project[]
}

// Analytics (simple)
model ContributionSnapshot {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  project   Project  @relation(fields: [projectId], references: [id])
  projectId String   @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id])
  date      DateTime @default(now())
  
  // Metrics
  documentsEdited   Int @default(0)
  charactersAdded   Int @default(0)
  chatMessages      Int @default(0)
  tasksCompleted    Int @default(0)
  
  @@unique([projectId, userId, date])
}

// Team Invitations
model Invitation {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  projectId   String   @db.ObjectId
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  email       String
  role        MemberRole @default(MEMBER)
  status      InvitationStatus @default(PENDING)
  invitedBy   String   @db.ObjectId
  inviter     User     @relation("SentInvitations", fields: [invitedBy], references: [id])
  createdAt   DateTime @default(now())
  expiresAt   DateTime
  
  @@index([projectId])
  @@index([email])
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

// Task Management
model Task {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  projectId   String   @db.ObjectId
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  title       String
  description String?  
  status      TaskStatus @default(TODO)
  assignedTo  String?  @db.ObjectId
  assignee    User?    @relation("AssignedTasks", fields: [assignedTo], references: [id])
  createdBy   String   @db.ObjectId
  creator     User     @relation("CreatedTasks", fields: [createdBy], references: [id])
  order       Int      @default(0)
  dueDate     DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([projectId])
  @@index([assignedTo])
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

// Faculty & Course Management
model Course {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  code        String
  semester    String
  year        Int
  facultyId   String   @db.ObjectId
  faculty     User     @relation(fields: [facultyId], references: [id])
  projects    Project[]
  rubrics     Rubric[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([facultyId])
}

model Rubric {
  id          String   @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  courseId    String?  @db.ObjectId
  course      Course?  @relation(fields: [courseId], references: [id])
  criteria    Json     // Array of {name, weight, maxScore, description}
  createdBy   String   @db.ObjectId
  creator     User     @relation(fields: [createdBy], references: [id])
  evaluations Evaluation[]
  createdAt   DateTime @default(now())
  
  @@index([courseId])
}

model Evaluation {
  id              String   @id @default(auto()) @map("_id") @db.ObjectId
  projectId       String   @unique @db.ObjectId
  project         Project  @relation(fields: [projectId], references: [id])
  evaluatorId     String   @db.ObjectId
  evaluator       User     @relation(fields: [evaluatorId], references: [id])
  rubricId        String?  @db.ObjectId
  rubric          Rubric?  @relation(fields: [rubricId], references: [id])
  scores          Json     // {criteriaId: score}
  totalScore      Float
  maxScore        Float
  feedback        String?  
  individualScores Json?   // {userId: adjustedScore}
  status          EvaluationStatus @default(DRAFT)
  submittedAt     DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@index([evaluatorId])
}

enum EvaluationStatus {
  DRAFT
  SUBMITTED
  PUBLISHED
}

// Excalidraw Whiteboard Data
model ExcalidrawData {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  projectId String   @unique @db.ObjectId
  elements  Json     // Excalidraw elements
  appState  Json?    // Excalidraw app state
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
